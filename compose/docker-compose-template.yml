version: '2'
services:
    nginx:
      build:
          context: ./nginx
      restart: always
      logging:
        driver: json-file
        options:
            max-size: "10m"
            max-file: "5" 
      volumes:
          - ./ssl:/etc/nginx/ssl         
      expose:
          - 80
          - 443
          - 8000
      ports:
          - "80:80"     
          - "443:443"   
          - "8000:8000"
      environment:
          - TZ=$TZ
          - SSL_ENABLED=$SSL_ENABLED
          - LETSENCRYPT=$LETSENCRYPT
          - LE_EMAIL=$LE_EMAIL
          - LE_FQDN=$LE_FQDN
          - PORTAL_USER=$PORTAL_USER
          - PORTAL_PASSWORD=$PORTAL_PASSWORD
      links:
          - alastria
          - graylog
    alastria:
      container_name: alastria
      image: alastria-node
      restart: always
      logging:
        driver: json-file
        options:
            max-size: "10m"
            max-file: "5" 
      volumes:
        - $DATA_DIR/geth:/root/alastria/data/geth
        - $DATA_DIR/constellation:/root/alastria/data/constellation
        - $CONFIG_DIR/data:/root/alastria-node/data
      ports:
        - 9000:9000/tcp
        - 21000:21000/tcp
        - 21000:21000/udp
        - 22000:22000/tcp
        - 8443:8443/tcp
    mongodb:
      image: mongo:3
    elasticsearch:
      image: docker.elastic.co/elasticsearch/elasticsearch:5.6.12
      environment:
        - http.host=0.0.0.0
        - transport.host=localhost
        - network.host=0.0.0.0
        # Disable X-Pack security: https://www.elastic.co/guide/en/elasticsearch/reference/5.6/security-settings.html#general-security-settings
        - xpack.security.enabled=false
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      ulimits:
        memlock:
          soft: -1
          hard: -1
      mem_limit: 1g
    graylog:
      image: graylog/graylog:3.0
      environment:
        # CHANGE ME!
        - GRAYLOG_PASSWORD_SECRET=somepasswordpepper
        # Password: admin
        - GRAYLOG_ROOT_PASSWORD_SHA2=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918
        - GRAYLOG_WEB_ENDPOINT_URI=http://127.0.0.1:9000/api
      links:
        - mongodb:mongo
        - elasticsearch
      depends_on:
        - mongodb
        - elasticsearch
      ports:
        # Graylog web interface and REST API
        #- 9000:9000
        # Syslog TCP
        - 514:514
        # Syslog UDP
        - 514:514/udp
        # GELF TCP
        - 12201:12201
        # GELF UDP
        - 12201:12201/udp      
        
